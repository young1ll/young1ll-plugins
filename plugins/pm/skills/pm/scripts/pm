#!/bin/bash
# pm - Project Management CLI
# í”„ë¡œì íŠ¸ ë¬¸ì„œ ê´€ë¦¬ í†µí•© ë„êµ¬

set -e

# ìŠ¤í¬ë¦½íŠ¸ ë””ë ‰í† ë¦¬ ê²½ë¡œ
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ
source "$SCRIPT_DIR/lib/common.sh"
source "$SCRIPT_DIR/lib/yaml-parser.sh"

# ============================================================
# pm help - ë„ì›€ë§
# ============================================================

pm_help() {
  local VERSION="1.0.0"

  # ì¶”ê°€ ìƒ‰ìƒ ì •ì˜
  local DIM='\033[2m'
  local MAGENTA='\033[0;35m'
  local WHITE='\033[1;37m'

  echo ""
  echo -e "${BOLD}${CYAN}  â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NC}"
  echo -e "${BOLD}${CYAN}  â”‚${NC}  ${WHITE}pm${NC} ${DIM}â€” Project Management CLI${NC}            ${DIM}v${VERSION}${NC}  ${BOLD}${CYAN}â”‚${NC}"
  echo -e "${BOLD}${CYAN}  â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NC}"
  echo ""

  echo -e "${BOLD}${WHITE}  USAGE${NC}"
  echo -e "    ${CYAN}pm${NC} ${DIM}<command>${NC} ${DIM}[options]${NC}"
  echo ""

  echo -e "${BOLD}${WHITE}  COMMANDS${NC}"
  echo ""
  echo -e "    ${GREEN}init${NC}              ìƒˆ í”„ë¡œì íŠ¸ ë¬¸ì„œ ì²´ê³„ ì´ˆê¸°í™”"
  echo -e "    ${GREEN}adopt${NC}             ê¸°ì¡´ í”„ë¡œì íŠ¸ì— ë¬¸ì„œ ì²´ê³„ ë„ì… ${DIM}(ì½”ë“œ ë¶„ì„)${NC}"
  echo -e "    ${CYAN}status${NC}            ë§ˆì¼ìŠ¤í†¤ ì§„í–‰ë¥  + ë¬¸ì„œ ìƒíƒœ í™•ì¸"
  echo -e "    ${CYAN}validate${NC}          í”„ë¡œì íŠ¸ ì „ì²´ ê²€ì¦ ${DIM}(6ê°€ì§€ í•­ëª©)${NC}"
  echo -e "    ${YELLOW}new-plan${NC} ${DIM}<name>${NC}   ê³„íš ë¬¸ì„œ ìƒì„±"
  echo -e "    ${YELLOW}new-report${NC} ${DIM}<topic>${NC} ë³´ê³ ì„œ ìƒì„±"
  echo -e "    ${BLUE}sync${NC}              MILESTONES ì§„í–‰ë¥  ë™ê¸°í™”"
  echo -e "    ${DIM}help${NC}              ì´ ë„ì›€ë§ í‘œì‹œ"
  echo ""

  echo -e "${BOLD}${WHITE}  EXAMPLES${NC}"
  echo ""
  echo -e "    ${DIM}# ìƒˆ í”„ë¡œì íŠ¸ ì‹œì‘${NC}"
  echo -e "    ${CYAN}pm init${NC}"
  echo ""
  echo -e "    ${DIM}# ê¸°ì¡´ í”„ë¡œì íŠ¸ì— ë„ì…${NC}"
  echo -e "    ${CYAN}pm adopt${NC}"
  echo ""
  echo -e "    ${DIM}# ì§„í–‰ ìƒí™© í™•ì¸${NC}"
  echo -e "    ${CYAN}pm status${NC}"
  echo ""
  echo -e "    ${DIM}# ê³„íš ë¬¸ì„œ ìƒì„±${NC}"
  echo -e "    ${CYAN}pm new-plan${NC} user-authentication"
  echo ""

  echo -e "${BOLD}${WHITE}  CLAUDE CODE${NC}"
  echo ""
  echo -e "    ${MAGENTA}/pm${NC}               ìŠ¤í‚¬ í˜¸ì¶œ"
  echo -e "    ${MAGENTA}/pm init${NC}          ìƒˆ í”„ë¡œì íŠ¸ ì´ˆê¸°í™”"
  echo -e "    ${MAGENTA}/pm adopt${NC}         ê¸°ì¡´ í”„ë¡œì íŠ¸ ë„ì…"
  echo -e "    ${MAGENTA}/pm status${NC}        ì§„í–‰ ìƒí™© í™•ì¸"
  echo ""

  echo -e "${DIM}  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
  echo -e "${DIM}  Learn more: ~/.claude/skills/pm/SKILL.md${NC}"
  echo ""
}

# ============================================================
# pm init - í”„ë¡œì íŠ¸ ì´ˆê¸°í™”
# ============================================================

pm_init() {
  pm_header "Project Initialization"

  if [ -f "PROJECT.yaml" ]; then
    pm_warn "PROJECT.yamlì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤"
    if ! confirm "ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?"; then
      pm_info "ì´ˆê¸°í™” ì·¨ì†Œë¨"
      exit 0
    fi
  fi

  pm_info "í”„ë¡œì íŠ¸ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
  echo ""

  # í”„ë¡œì íŠ¸ ì´ë¦„
  read -r -p "í”„ë¡œì íŠ¸ ì´ë¦„: " project_name
  project_name=${project_name:-my-project}

  # í”„ë¡œì íŠ¸ ì„¤ëª…
  read -r -p "í”„ë¡œì íŠ¸ ì„¤ëª…: " project_desc
  project_desc=${project_desc:-í”„ë¡œì íŠ¸ ì„¤ëª…}

  # ë¬¸ì„œ ë””ë ‰í† ë¦¬
  read -r -p "ê³„íš ë¬¸ì„œ ë””ë ‰í† ë¦¬ [docs/plans]: " plans_dir
  plans_dir=${plans_dir:-docs/plans}

  read -r -p "ë³´ê³ ì„œ ë””ë ‰í† ë¦¬ [docs/reports]: " reports_dir
  reports_dir=${reports_dir:-docs/reports}

  echo ""
  pm_info "PROJECT.yaml ìƒì„± ì¤‘..."

  cat > PROJECT.yaml << EOF
name: $project_name
description: $project_desc

core_docs:
  vision: MANIFESTO.md
  progress: MILESTONES.md

plans_dir: $plans_dir
reports_dir: $reports_dir

meta:
  created: $(get_date)
EOF

  pm_success "PROJECT.yaml ìƒì„± ì™„ë£Œ"

  # í•„ìˆ˜ ë¬¸ì„œ ìƒì„±
  pm_info "í•„ìˆ˜ ë¬¸ì„œ ìƒì„± ì¤‘..."

  # MANIFESTO.md
  if [ ! -f "MANIFESTO.md" ]; then
    if [ -f "$TEMPLATES_DIR/MANIFESTO.md.tpl" ]; then
      cp "$TEMPLATES_DIR/MANIFESTO.md.tpl" MANIFESTO.md
    else
      cat > MANIFESTO.md << 'EOF'
# Project Manifesto

## Vision
[í”„ë¡œì íŠ¸ê°€ ë‹¬ì„±í•˜ê³ ì í•˜ëŠ” ìµœì¢… ëª©í‘œ]

## Core Values
1. **[ê°€ì¹˜]**: [ì„¤ëª…]

## Success Criteria
- [ì„±ê³µ ê¸°ì¤€]

## Non-Goals
- [í•˜ì§€ ì•Šì„ ê²ƒ]

## Principles
- [ì›ì¹™]
EOF
    fi
    pm_success "MANIFESTO.md ìƒì„±"
  else
    pm_info "MANIFESTO.md ì´ë¯¸ ì¡´ì¬"
  fi

  # MILESTONES.md
  if [ ! -f "MILESTONES.md" ]; then
    if [ -f "$TEMPLATES_DIR/MILESTONES.md.tpl" ]; then
      cp "$TEMPLATES_DIR/MILESTONES.md.tpl" MILESTONES.md
    else
      cat > MILESTONES.md << EOF
# Milestones

> Last updated: $(get_date)

## Current: v0.1.0
> Target: TBD | Progress: 0%

### Goals
- [ëª©í‘œ]

### Tasks
- [ ] Task

### Blockers
- None

---

## Next: v0.2.0

---

## Completed
EOF
    fi
    pm_success "MILESTONES.md ìƒì„±"
  else
    pm_info "MILESTONES.md ì´ë¯¸ ì¡´ì¬"
  fi

  # ë””ë ‰í† ë¦¬ ìƒì„±
  ensure_dir "$plans_dir"
  ensure_dir "$reports_dir"

  echo ""
  pm_header "ì´ˆê¸°í™” ì™„ë£Œ"
  pm_info "ë‹¤ìŒ ë‹¨ê³„:"
  echo "  1. MANIFESTO.md í¸ì§‘ - í”„ë¡œì íŠ¸ ë¹„ì „ ì •ì˜"
  echo "  2. MILESTONES.md í¸ì§‘ - ëª©í‘œ ë° íƒœìŠ¤í¬ ì •ì˜"
  echo "  3. pm status - ì§„í–‰ ìƒí™© í™•ì¸"
}

# ============================================================
# pm adopt - ê¸°ì¡´ í”„ë¡œì íŠ¸ ë¶„ì„ ë° ë„ì…
# ============================================================

pm_adopt() {
  pm_header "Project Adoption (ê¸°ì¡´ í”„ë¡œì íŠ¸ ë¶„ì„)"

  if [ -f "PROJECT.yaml" ]; then
    pm_warn "PROJECT.yamlì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤"
    if ! confirm "ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?"; then
      pm_info "ë„ì… ì·¨ì†Œë¨"
      exit 0
    fi
  fi

  pm_info "ì½”ë“œë² ì´ìŠ¤ ë¶„ì„ ì¤‘..."
  echo ""

  # í”„ë¡œì íŠ¸ ìœ í˜• ê°ì§€
  local project_type="unknown"
  local detected_stack=""
  local suggested_docs=""

  # Node.js í”„ë¡œì íŠ¸
  if [ -f "package.json" ]; then
    detected_stack="Node.js"
    if grep -q "react\|vue\|next\|nuxt" package.json 2>/dev/null; then
      project_type="frontend"
      suggested_docs="architecture, components"
    elif grep -q "express\|fastify\|nestjs\|koa" package.json 2>/dev/null; then
      project_type="backend"
      suggested_docs="api_spec, domain_model, decisions"
    fi
  fi

  # Python í”„ë¡œì íŠ¸
  if [ -f "pyproject.toml" ] || [ -f "requirements.txt" ]; then
    detected_stack="Python"
    if grep -qE "torch|tensorflow|keras|wandb|mlflow" pyproject.toml requirements.txt 2>/dev/null; then
      project_type="ml"
      suggested_docs="experiments, metrics, data_schema, architecture"
    elif grep -qE "fastapi|flask|django" pyproject.toml requirements.txt 2>/dev/null; then
      project_type="backend"
      suggested_docs="api_spec, domain_model, decisions"
    fi
  fi

  # Go í”„ë¡œì íŠ¸
  if [ -f "go.mod" ]; then
    detected_stack="Go"
    project_type="backend"
    suggested_docs="api_spec, architecture, decisions"
  fi

  # Rust í”„ë¡œì íŠ¸
  if [ -f "Cargo.toml" ]; then
    detected_stack="Rust"
    project_type="library"
    suggested_docs="api_spec, architecture, decisions"
  fi

  # ë””ë ‰í† ë¦¬ êµ¬ì¡° ë¶„ì„
  local has_models=false
  local has_data=false
  local has_api=false
  local has_migrations=false
  local has_experiments=false

  [ -d "models" ] || [ -d "src/models" ] && has_models=true
  [ -d "data" ] || [ -d "datasets" ] && has_data=true
  [ -d "api" ] || [ -d "src/api" ] || [ -d "routes" ] && has_api=true
  [ -d "migrations" ] && has_migrations=true
  [ -d "experiments" ] && has_experiments=true

  # ê¸°ì¡´ ë¬¸ì„œ í™•ì¸
  local existing_docs=""
  [ -f "README.md" ] && existing_docs="$existing_docs README.md"
  [ -d "docs" ] && existing_docs="$existing_docs docs/"

  # ê²°ê³¼ ì¶œë ¥
  echo -e "${BOLD}[ë¶„ì„ ê²°ê³¼]${NC}"
  echo "  ìŠ¤íƒ: $detected_stack"
  echo "  ìœ í˜•: $project_type"
  echo "  ê¸°ì¡´ ë¬¸ì„œ: ${existing_docs:-ì—†ìŒ}"
  echo ""

  echo -e "${BOLD}[ë””ë ‰í† ë¦¬ êµ¬ì¡°]${NC}"
  $has_models && echo "  + models/ â†’ architecture ê¶Œì¥"
  $has_data && echo "  + data/ â†’ data_schema ê¶Œì¥"
  $has_api && echo "  + api/ â†’ api_spec ê¶Œì¥"
  $has_migrations && echo "  + migrations/ â†’ domain_model ê¶Œì¥"
  $has_experiments && echo "  + experiments/ â†’ experiments ê¶Œì¥"
  echo ""

  echo -e "${BOLD}[ì œì•ˆ core_docs]${NC}"
  echo "  vision: MANIFESTO.md"
  echo "  progress: MILESTONES.md"
  [ -n "$suggested_docs" ] && echo "  ì¶”ê°€ ê¶Œì¥: $suggested_docs"
  echo ""

  pm_info "Claude Codeì—ì„œ '/pm adopt' ì‹¤í–‰ ì‹œ ë” ìƒì„¸í•œ ë¶„ì„ê³¼ ëŒ€í™”í˜• ì„¤ì •ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤."
  echo ""

  if ! confirm "ê¸°ë³¸ êµ¬ì¡°ë¡œ PROJECT.yamlì„ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"; then
    pm_info "ë„ì… ì·¨ì†Œë¨. Claude Codeì—ì„œ '/pm adopt'ë¥¼ ì‚¬ìš©í•´ ìƒì„¸ ì„¤ì •í•˜ì„¸ìš”."
    exit 0
  fi

  # í”„ë¡œì íŠ¸ ì´ë¦„ ì¶”ë¡ 
  local project_name
  project_name=$(basename "$PWD")

  # ê¸°ë³¸ PROJECT.yaml ìƒì„±
  cat > PROJECT.yaml << EOF
name: $project_name
description: (ì„¤ëª…ì„ ì¶”ê°€í•˜ì„¸ìš”)

core_docs:
  vision: MANIFESTO.md
  progress: MILESTONES.md

plans_dir: docs/plans
reports_dir: docs/reports

meta:
  stack: [$detected_stack]
  type: $project_type
  adopted: $(get_date)
EOF

  pm_success "PROJECT.yaml ìƒì„± ì™„ë£Œ"

  # í•„ìˆ˜ ë¬¸ì„œ ìƒì„± (ê¸°ì¡´ ë¬¸ì„œ ë³´ì¡´)
  if [ ! -f "MANIFESTO.md" ]; then
    if [ -f "README.md" ]; then
      pm_info "README.mdë¥¼ ê¸°ë°˜ìœ¼ë¡œ MANIFESTO.md ìƒì„±..."
      echo "# Project Manifesto" > MANIFESTO.md
      echo "" >> MANIFESTO.md
      echo "> ì´ ë¬¸ì„œëŠ” README.mdë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. í¸ì§‘í•´ì£¼ì„¸ìš”." >> MANIFESTO.md
      echo "" >> MANIFESTO.md
      cat README.md >> MANIFESTO.md
    else
      cp "$TEMPLATES_DIR/MANIFESTO.md.tpl" MANIFESTO.md 2>/dev/null || cat > MANIFESTO.md << 'EOF'
# Project Manifesto

## Vision
[í”„ë¡œì íŠ¸ê°€ ë‹¬ì„±í•˜ê³ ì í•˜ëŠ” ìµœì¢… ëª©í‘œ]

## Core Values
1. **[ê°€ì¹˜]**: [ì„¤ëª…]

## Success Criteria
- [ì„±ê³µ ê¸°ì¤€]
EOF
    fi
    pm_success "MANIFESTO.md ìƒì„±"
  fi

  if [ ! -f "MILESTONES.md" ]; then
    cat > MILESTONES.md << EOF
# Milestones

> Last updated: $(get_date)
> Adopted from existing project

## Current: v1.0.0
> Target: TBD | Progress: 0%

### Goals
- [ê¸°ì¡´ í”„ë¡œì íŠ¸ ë¬¸ì„œí™” ì™„ë£Œ]

### Tasks
- [ ] MANIFESTO.md í¸ì§‘
- [ ] core_docs ì¶”ê°€ (í•„ìš”ì‹œ)
- [ ] ë§ˆì¼ìŠ¤í†¤ ì •ì˜

### Blockers
- None

---

## Completed
EOF
    pm_success "MILESTONES.md ìƒì„±"
  fi

  ensure_dir "docs/plans"
  ensure_dir "docs/reports"

  echo ""
  pm_header "ë„ì… ì™„ë£Œ"
  pm_info "ë‹¤ìŒ ë‹¨ê³„:"
  echo "  1. MANIFESTO.md í¸ì§‘ - í”„ë¡œì íŠ¸ ë¹„ì „ ì •ì˜"
  echo "  2. PROJECT.yaml í¸ì§‘ - ì¶”ê°€ core_docs ì„¤ì •"
  echo "  3. pm status - ì§„í–‰ ìƒí™© í™•ì¸"
}

# ============================================================
# pm status - ì§„í–‰ ìƒí™© í™•ì¸
# ============================================================

pm_status() {
  require_project_yaml

  pm_header "Project Status"

  # í”„ë¡œì íŠ¸ ì •ë³´
  local project_name
  project_name=$(yaml_project_name)
  echo -e "${BOLD}Project:${NC} $project_name"
  echo ""

  # MILESTONES.md íŒŒì‹±
  local milestones_file
  milestones_file=$(yaml_get_core_doc "progress")
  milestones_file=${milestones_file:-MILESTONES.md}

  if [ ! -f "$milestones_file" ]; then
    pm_warn "ë§ˆì¼ìŠ¤í†¤ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: $milestones_file"
    return 1
  fi

  # í˜„ì¬ ë§ˆì¼ìŠ¤í†¤ ì¶”ì¶œ
  local current_section
  current_section=$(awk '/^## Current:/,/^---$/' "$milestones_file")

  # ë§ˆì¼ìŠ¤í†¤ ì´ë¦„
  local milestone_name
  milestone_name=$(echo "$current_section" | grep '## Current:' | sed 's/## Current:[[:space:]]*//')
  echo -e "${CYAN}Current Milestone:${NC} $milestone_name"
  echo ""

  # íƒœìŠ¤í¬ ì¹´ìš´íŠ¸
  local total completed remaining
  total=$(echo "$current_section" | grep -c '\- \[.\]' || echo "0")
  completed=$(echo "$current_section" | grep -c '\- \[x\]' || echo "0")
  remaining=$((total - completed))

  echo "Tasks: $completed/$total completed"
  progress_bar "$completed" "$total"

  if [ "$remaining" -gt 0 ]; then
    echo ""
    echo "Remaining:"
    echo "$current_section" | grep '\- \[ \]' | sed 's/- \[ \]/  -/'
  fi

  # ë¬¸ì„œ ìƒíƒœ
  echo ""
  pm_header "Document Status"

  local core_docs
  core_docs=$(yaml_get_core_docs)

  while IFS=':' read -r role path; do
    [ -z "$role" ] && continue
    if [ -f "$path" ]; then
      local modified
      modified=$(stat -f "%Sm" -t "%Y-%m-%d" "$path" 2>/dev/null || stat -c "%y" "$path" 2>/dev/null | cut -d' ' -f1)
      echo -e "  ${GREEN}+${NC} $role: $path (${modified})"
    else
      echo -e "  ${RED}-${NC} $role: $path (missing)"
    fi
  done <<< "$core_docs"
}

# ============================================================
# pm validate - í¬ê´„ì  í”„ë¡œì íŠ¸ ê²€ì¦
# ============================================================

# ê²€ì¦ ê²°ê³¼ ì¹´ìš´í„°
VALIDATE_ERRORS=0
VALIDATE_WARNINGS=0
VALIDATE_PASSED=0

validate_pass() {
  echo -e "  ${GREEN}âœ“${NC} $*"
  VALIDATE_PASSED=$((VALIDATE_PASSED + 1))
}

validate_warn() {
  echo -e "  ${YELLOW}âš ${NC} $*"
  VALIDATE_WARNINGS=$((VALIDATE_WARNINGS + 1))
}

validate_fail() {
  echo -e "  ${RED}âœ—${NC} $*"
  VALIDATE_ERRORS=$((VALIDATE_ERRORS + 1))
}

validate_info() {
  echo -e "  ${CYAN}â„¹${NC} $*"
}

pm_validate() {
  require_project_yaml

  local project_name
  project_name=$(yaml_project_name)

  echo ""
  echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}  ğŸ” PM Validate â€” $project_name${NC}"
  echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""

  # ============================================================
  # 1. êµ¬ì¡° ê²€ì¦ (Structure)
  # ============================================================
  echo -e "${BOLD}ğŸ“ 1. êµ¬ì¡° ê²€ì¦${NC}"

  # PROJECT.yaml í•„ìˆ˜ í•„ë“œ
  if [ -n "$(yaml_get 'name')" ]; then
    validate_pass "PROJECT.yaml: name í•„ë“œ ì¡´ì¬"
  else
    validate_fail "PROJECT.yaml: name í•„ë“œ ëˆ„ë½"
  fi

  if [ -n "$(yaml_get_core_doc 'vision')" ]; then
    validate_pass "core_docs: vision ì •ì˜ë¨"
  else
    validate_fail "core_docs: vision í•„ìˆ˜ (MANIFESTO.md)"
  fi

  if [ -n "$(yaml_get_core_doc 'progress')" ]; then
    validate_pass "core_docs: progress ì •ì˜ë¨"
  else
    validate_fail "core_docs: progress í•„ìˆ˜ (MILESTONES.md)"
  fi

  local plans_dir reports_dir
  plans_dir=$(yaml_plans_dir)
  reports_dir=$(yaml_reports_dir)

  [ -d "$plans_dir" ] && validate_pass "plans_dir: $plans_dir" || validate_warn "plans_dir: $plans_dir (ì—†ìŒ)"
  [ -d "$reports_dir" ] && validate_pass "reports_dir: $reports_dir" || validate_warn "reports_dir: $reports_dir (ì—†ìŒ)"

  echo ""

  # ============================================================
  # 2. ë¬¸ì„œ ì¡´ì¬ ê²€ì¦ (Existence)
  # ============================================================
  echo -e "${BOLD}ğŸ“„ 2. ë¬¸ì„œ ì¡´ì¬ ê²€ì¦${NC}"

  local core_docs
  core_docs=$(yaml_get_core_docs)

  while IFS=':' read -r role path; do
    [ -z "$role" ] && continue
    if [ -f "$path" ]; then
      validate_pass "$role: $path"
    else
      validate_fail "$role: $path (ì—†ìŒ)"
    fi
  done <<< "$core_docs"

  echo ""

  # ============================================================
  # 3. ë¬¸ì„œ í’ˆì§ˆ ê²€ì¦ (Quality)
  # ============================================================
  echo -e "${BOLD}ğŸ“ 3. ë¬¸ì„œ í’ˆì§ˆ ê²€ì¦${NC}"

  while IFS=':' read -r role path; do
    [ -z "$role" ] && continue
    [ ! -f "$path" ] && continue

    # íŒŒì¼ í¬ê¸° í™•ì¸ (ë„ˆë¬´ ì‘ìœ¼ë©´ ê²½ê³ )
    local size
    size=$(wc -c < "$path" | tr -d ' ')
    if [ "$size" -lt 100 ]; then
      validate_warn "$path: ë‚´ìš©ì´ ë„ˆë¬´ ì ìŒ (${size}bytes)"
    fi

    # í…œí”Œë¦¿ í”Œë ˆì´ìŠ¤í™€ë” í™•ì¸
    if grep -qE '\[í”„ë¡œì íŠ¸|ì„¤ëª…\]|\[ëª©í‘œ\]|\[ê°€ì¹˜\]|\[TBD\]|YYYY-MM-DD' "$path" 2>/dev/null; then
      validate_warn "$path: í…œí”Œë¦¿ í”Œë ˆì´ìŠ¤í™€ë” ë‚¨ì•„ìˆìŒ"
    fi

    # ë§ˆì§€ë§‰ ìˆ˜ì •ì¼ í™•ì¸ (30ì¼ ì´ìƒì´ë©´ ê²½ê³ )
    local mod_time now_time diff_days
    if [ "$OS_TYPE" = "macos" ]; then
      mod_time=$(stat -f "%m" "$path" 2>/dev/null)
      now_time=$(date +%s)
    else
      mod_time=$(stat -c "%Y" "$path" 2>/dev/null)
      now_time=$(date +%s)
    fi

    if [ -n "$mod_time" ]; then
      diff_days=$(( (now_time - mod_time) / 86400 ))
      if [ "$diff_days" -gt 30 ]; then
        # ignore ê·œì¹™ ë° íŒŒì¼ íŒ¨í„´ ì²´í¬
        if ! is_ignored_rule "stale_documents" && ! is_ignored_file "$path"; then
          validate_warn "$path: ${diff_days}ì¼ ì „ ë§ˆì§€ë§‰ ìˆ˜ì •"
        fi
      fi
    fi

  done <<< "$core_docs"

  # MILESTONES.md íŠ¹ë³„ ê²€ì‚¬
  local milestones_file
  milestones_file=$(yaml_get_core_doc "progress")
  if [ -f "$milestones_file" ]; then
    # ë¸”ë¡œì»¤ í™•ì¸
    if grep -q "^- [^N]" "$milestones_file" 2>/dev/null | grep -qi "blocker"; then
      validate_warn "$milestones_file: ë¸”ë¡œì»¤ê°€ ì¡´ì¬í•¨"
    fi
  fi

  echo ""

  # ============================================================
  # 4. ì¼ê´€ì„± ê²€ì¦ (Consistency)
  # ============================================================
  echo -e "${BOLD}ğŸ”— 4. ì¼ê´€ì„± ê²€ì¦${NC}"

  # ë“±ë¡ë˜ì§€ ì•Šì€ ë¬¸ì„œ íŒŒì¼ í™•ì¸
  local unregistered=0
  local ignored_count=0
  if [ -d "docs" ]; then
    for doc_file in docs/*.md; do
      [ ! -f "$doc_file" ] && continue

      # ignore íŒŒì¼ íŒ¨í„´ ì²´í¬
      if is_ignored_file "$doc_file"; then
        ignored_count=$((ignored_count + 1))
        continue
      fi

      local is_registered=false

      while IFS=':' read -r role path; do
        [ -z "$path" ] && continue
        if [ "$path" = "$doc_file" ]; then
          is_registered=true
          break
        fi
      done <<< "$core_docs"

      if [ "$is_registered" = false ]; then
        # unregistered_docs ê·œì¹™ì´ ë¬´ì‹œë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ê²½ê³ 
        if ! is_ignored_rule "unregistered_docs"; then
          validate_info "$doc_file: core_docsì— ë¯¸ë“±ë¡"
          unregistered=$((unregistered + 1))
        fi
      fi
    done
  fi

  if [ "$unregistered" -eq 0 ]; then
    if [ "$ignored_count" -gt 0 ]; then
      validate_pass "ëª¨ë“  docs/*.md íŒŒì¼ì´ core_docsì— ë“±ë¡ë¨ (${ignored_count}ê°œ ë¬´ì‹œë¨)"
    else
      validate_pass "ëª¨ë“  docs/*.md íŒŒì¼ì´ core_docsì— ë“±ë¡ë¨"
    fi
  fi

  # MILESTONES ì§„í–‰ë¥  ë™ê¸°í™” í™•ì¸
  if [ -f "$milestones_file" ]; then
    local current_section
    current_section=$(awk '/^## Current:/,/^---$/' "$milestones_file")
    local total completed actual_progress stated_progress

    total=$(echo "$current_section" | grep -c '\- \[.\]' || echo "0")
    completed=$(echo "$current_section" | grep -c '\- \[x\]' || echo "0")

    if [ "$total" -gt 0 ]; then
      actual_progress=$((completed * 100 / total))
    else
      actual_progress=0
    fi

    stated_progress=$(echo "$current_section" | grep -oE 'Progress: [0-9]+%' | grep -oE '[0-9]+' || echo "0")

    if [ "$actual_progress" -eq "$stated_progress" ]; then
      validate_pass "MILESTONES ì§„í–‰ë¥  ë™ê¸°í™”ë¨ (${actual_progress}%)"
    else
      validate_warn "MILESTONES ì§„í–‰ë¥  ë¶ˆì¼ì¹˜: í‘œê¸°=${stated_progress}%, ì‹¤ì œ=${actual_progress}%"
    fi
  fi

  echo ""

  # ============================================================
  # 5. ì¤‘ë³µ/ë¶ˆí•„ìš” íŒŒì¼ ê²€ì‚¬ (Cleanup)
  # ============================================================
  echo -e "${BOLD}ğŸ§¹ 5. ì¤‘ë³µ/ë¶ˆí•„ìš” íŒŒì¼ ê²€ì‚¬${NC}"

  local cleanup_issues=0

  # ì˜¤ë˜ëœ DRAFT ìƒíƒœ PLAN íŒŒì¼
  if [ -d "$plans_dir" ]; then
    for plan in "$plans_dir"/PLAN_*.md; do
      [ ! -f "$plan" ] && continue

      # ignore íŒŒì¼ íŒ¨í„´ ì²´í¬
      if is_ignored_file "$plan"; then
        continue
      fi

      if grep -q "status: DRAFT" "$plan" 2>/dev/null; then
        local plan_mod_time
        if [ "$OS_TYPE" = "macos" ]; then
          plan_mod_time=$(stat -f "%m" "$plan" 2>/dev/null)
        else
          plan_mod_time=$(stat -c "%Y" "$plan" 2>/dev/null)
        fi
        if [ -n "$plan_mod_time" ]; then
          local plan_age=$(( (now_time - plan_mod_time) / 86400 ))
          if [ "$plan_age" -gt 14 ]; then
            # old_drafts ê·œì¹™ì´ ë¬´ì‹œë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ê²½ê³ 
            if ! is_ignored_rule "old_drafts"; then
              validate_warn "$plan: DRAFT ìƒíƒœë¡œ ${plan_age}ì¼ ê²½ê³¼"
              cleanup_issues=$((cleanup_issues + 1))
            fi
          fi
        fi
      fi
    done
  fi

  # ë¹„ìŠ·í•œ ì´ë¦„ì˜ íŒŒì¼ ê°ì§€ (docs ë””ë ‰í† ë¦¬)
  if [ -d "docs" ]; then
    local similar_files
    similar_files=$(ls docs/*.md 2>/dev/null | xargs -I {} basename {} .md | sort | uniq -d)
    if [ -n "$similar_files" ]; then
      validate_warn "ìœ ì‚¬í•œ ì´ë¦„ì˜ íŒŒì¼ ë°œê²¬: $similar_files"
      cleanup_issues=$((cleanup_issues + 1))
    fi
  fi

  # ì„ì‹œ/ë°±ì—… íŒŒì¼
  local temp_files
  local temp_count=0
  while IFS= read -r temp_file; do
    [ -z "$temp_file" ] && continue
    # ignore íŒŒì¼ íŒ¨í„´ ì²´í¬
    if ! is_ignored_file "$temp_file"; then
      temp_count=$((temp_count + 1))
    fi
  done < <(find . -maxdepth 2 \( -name "*.bak" -o -name "*~" -o -name "*.tmp" \) 2>/dev/null | head -10)

  if [ "$temp_count" -gt 0 ]; then
    # temp_files ê·œì¹™ì´ ë¬´ì‹œë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ê²½ê³ 
    if ! is_ignored_rule "temp_files"; then
      validate_warn "ì„ì‹œ/ë°±ì—… íŒŒì¼ ë°œê²¬ (${temp_count}ê°œ)"
      cleanup_issues=$((cleanup_issues + 1))
    fi
  fi

  if [ "$cleanup_issues" -eq 0 ]; then
    validate_pass "ì •ë¦¬ê°€ í•„ìš”í•œ íŒŒì¼ ì—†ìŒ"
  fi

  echo ""

  # ============================================================
  # 6. ì§„í–‰ ìƒíƒœ ê²€ì¦ (Progress)
  # ============================================================
  echo -e "${BOLD}ğŸ“Š 6. ì§„í–‰ ìƒíƒœ ê²€ì¦${NC}"

  if [ -f "$milestones_file" ]; then
    local current_section
    current_section=$(awk '/^## Current:/,/^---$/' "$milestones_file")

    local milestone_name
    milestone_name=$(echo "$current_section" | grep '## Current:' | sed 's/## Current:[[:space:]]*//')

    local total completed remaining
    total=$(echo "$current_section" | grep -c '\- \[.\]' || echo "0")
    completed=$(echo "$current_section" | grep -c '\- \[x\]' || echo "0")
    remaining=$((total - completed))

    validate_info "í˜„ì¬ ë§ˆì¼ìŠ¤í†¤: $milestone_name"
    validate_info "íƒœìŠ¤í¬: $completed/$total ì™„ë£Œ ($remaining ë‚¨ìŒ)"

    if [ "$total" -gt 0 ]; then
      local progress=$((completed * 100 / total))
      if [ "$progress" -ge 80 ]; then
        validate_pass "ì§„í–‰ë¥  ì–‘í˜¸: ${progress}%"
      elif [ "$progress" -ge 50 ]; then
        validate_info "ì§„í–‰ë¥ : ${progress}%"
      else
        validate_warn "ì§„í–‰ë¥  ì €ì¡°: ${progress}%"
      fi
    fi

    # ë¸”ë¡œì»¤ í™•ì¸
    local blockers
    blockers=$(echo "$current_section" | awk '/^### Blockers/,/^###/' | grep -v "^###" | grep -v "^- None" | grep "^-" | wc -l | tr -d ' ')
    if [ "$blockers" -gt 0 ]; then
      validate_warn "${blockers}ê°œ ë¸”ë¡œì»¤ ì¡´ì¬"
    else
      validate_pass "ë¸”ë¡œì»¤ ì—†ìŒ"
    fi
  fi

  echo ""

  # ============================================================
  # ê²°ê³¼ ìš”ì•½
  # ============================================================
  echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BOLD}  ğŸ“‹ ê²€ì¦ ê²°ê³¼ ìš”ì•½${NC}"
  echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  echo -e "  ${GREEN}âœ“ í†µê³¼${NC}: $VALIDATE_PASSED"
  echo -e "  ${YELLOW}âš  ê²½ê³ ${NC}: $VALIDATE_WARNINGS"
  echo -e "  ${RED}âœ— ì˜¤ë¥˜${NC}: $VALIDATE_ERRORS"
  echo ""

  if [ "$VALIDATE_ERRORS" -gt 0 ]; then
    echo -e "  ${RED}ìƒíƒœ: ì˜¤ë¥˜ ë°œê²¬ â€” ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤${NC}"
    exit 1
  elif [ "$VALIDATE_WARNINGS" -gt 0 ]; then
    echo -e "  ${YELLOW}ìƒíƒœ: ê²½ê³  ìˆìŒ â€” ê²€í† ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤${NC}"
    exit 0
  else
    echo -e "  ${GREEN}ìƒíƒœ: ëª¨ë“  ê²€ì¦ í†µê³¼${NC}"
    exit 0
  fi
}

# ============================================================
# pm new-plan - ê³„íš ë¬¸ì„œ ìƒì„±
# ============================================================

pm_new_plan() {
  local name="$1"

  if [ -z "$name" ]; then
    pm_error "ì‚¬ìš©ë²•: pm new-plan <name>"
    exit 1
  fi

  require_project_yaml

  local plans_dir
  plans_dir=$(yaml_plans_dir)

  ensure_dir "$plans_dir"

  local safe_name
  safe_name=$(slugify "$name")
  local file="$plans_dir/PLAN_${safe_name}.md"

  if [ -f "$file" ]; then
    pm_error "íŒŒì¼ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤: $file"
    exit 1
  fi

  # í˜„ì¬ ë§ˆì¼ìŠ¤í†¤ ê°€ì ¸ì˜¤ê¸°
  local milestone=""
  local milestones_file
  milestones_file=$(yaml_get_core_doc "progress")
  if [ -f "$milestones_file" ]; then
    milestone=$(grep '## Current:' "$milestones_file" | sed 's/## Current:[[:space:]]*//' | head -1)
  fi

  local title
  title=$(echo "$name" | tr '-' ' ')

  cat > "$file" << EOF
---
status: DRAFT
created: $(get_date)
updated: $(get_date)
milestone: $milestone
---

# Plan: $title

## Overview

## Goals
-

## Approach

## Tasks
- [ ]

## Dependencies

## Notes
EOF

  pm_success "ìƒì„±ë¨: $file"
}

# ============================================================
# pm new-report - ë³´ê³ ì„œ ìƒì„±
# ============================================================

pm_new_report() {
  local topic="${1:-update}"
  local type="${2:-implementation}"

  require_project_yaml

  local reports_dir
  reports_dir=$(yaml_reports_dir)

  ensure_dir "$reports_dir"

  local safe_topic
  safe_topic=$(slugify "$topic")
  local file="$reports_dir/REPORT_$(get_date)_${safe_topic}.md"

  if [ -f "$file" ]; then
    pm_error "íŒŒì¼ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤: $file"
    exit 1
  fi

  # í˜„ì¬ ë§ˆì¼ìŠ¤í†¤ ê°€ì ¸ì˜¤ê¸°
  local milestone=""
  local milestones_file
  milestones_file=$(yaml_get_core_doc "progress")
  if [ -f "$milestones_file" ]; then
    milestone=$(grep '## Current:' "$milestones_file" | sed 's/## Current:[[:space:]]*//' | head -1)
  fi

  cat > "$file" << EOF
---
date: $(get_date)
type: $type
milestone: $milestone
---

# Report: $topic

## Summary

## What Was Done

## Results

## Lessons Learned

## Next Steps
- [ ]
EOF

  pm_success "ìƒì„±ë¨: $file (type: $type)"
}

# ============================================================
# pm sync - ë§ˆì¼ìŠ¤í†¤ ë™ê¸°í™”
# ============================================================

pm_sync() {
  require_project_yaml

  pm_header "Milestone Sync"

  local milestones_file
  milestones_file=$(yaml_get_core_doc "progress")
  milestones_file=${milestones_file:-MILESTONES.md}

  if [ ! -f "$milestones_file" ]; then
    pm_error "ë§ˆì¼ìŠ¤í†¤ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: $milestones_file"
    exit 1
  fi

  # í˜„ì¬ ë§ˆì¼ìŠ¤í†¤ì—ì„œ ì§„í–‰ë¥  ê³„ì‚°
  local current_section
  current_section=$(awk '/^## Current:/,/^---$/' "$milestones_file")

  local total completed
  total=$(echo "$current_section" | grep -c '\- \[.\]' || echo "0")
  completed=$(echo "$current_section" | grep -c '\- \[x\]' || echo "0")

  local progress=0
  if [ "$total" -gt 0 ]; then
    progress=$((completed * 100 / total))
  fi

  # Progress ì—…ë°ì´íŠ¸
  sed_inplace "s/Progress: [0-9]*%/Progress: $progress%/" "$milestones_file"

  # Last updated ì—…ë°ì´íŠ¸
  sed_inplace "s/Last updated: [0-9-]*/Last updated: $(get_date)/" "$milestones_file"

  pm_success "ì§„í–‰ë¥  ì—…ë°ì´íŠ¸: $progress%"
  pm_info "íŒŒì¼ ì—…ë°ì´íŠ¸: $milestones_file"
}

# ============================================================
# ë©”ì¸ ë¼ìš°í„°
# ============================================================

main() {
  local command="${1:-help}"
  shift 2>/dev/null || true

  case "$command" in
    init)       pm_init "$@" ;;
    adopt)      pm_adopt "$@" ;;
    status)     pm_status "$@" ;;
    validate)   pm_validate "$@" ;;
    new-plan)   pm_new_plan "$@" ;;
    new-report) pm_new_report "$@" ;;
    sync)       pm_sync "$@" ;;
    help|--help|-h) pm_help ;;
    *)
      pm_error "ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì–´: $command"
      echo ""
      pm_help
      exit 1
      ;;
  esac
}

main "$@"
